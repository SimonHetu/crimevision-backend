generator client {
  provider = "prisma-client" // Librairie TypeScript utilisée par le backend pour parler à la DB
  output   = "../generated/prisma" // Emplacement du client prisma généré
}

datasource db {
  provider = "postgresql" // La base de donnée utilisée
}

// Enums: Liste prédéfinie de valeur autorisées pour un champ
enum TimePeriod {
  jour
  nuit
  soir
}

enum Role {
  USER
  ADMIN
  MODERATOR
}


model Pdq {
  id              Int        @id
  name            String     @default("")
  address         String     @default("")
  cityCode        String     @default("")
  latitude        Float      @default(0)
  longitude       Float      @default(0)

  incidents Incident[] // Relation qui definit que 1 PDQ peut etre relier a plusieurs incidents        
}

model Incident {
  id              Int       @id @default(autoincrement())
  source          String  // Nom du fournisseur des données
  sourceId        Int     // Identifiant unique de la source externe

  @@unique([source, sourceId], name: "source_sourceId") 
  // La combinaison source et sourceId doit etre unique, sourceId peut exister plusieurs fois mais pas pour la meme source

  category        String    // Document de définition des incidents
  date            DateTime
  timePeriod      TimePeriod // Choix enum

  // Geometrie 
  x               Float?
  y               Float?
  longitude       Float? // Explication dans le document de présentation
  latitude        Float?

  // PDQ Id et relation (1 à N)
  pdqId           Int
  pdq             Pdq       @relation(fields: [pdqId], references: [id])

  // Indexes
  @@index([pdqId, date]) // Pour chercher par PDQ + date
  @@index([date]) // Par date: pour incident recent, dernier 7 jours, dernier 30 jours
  @@index([category])
  @@index([pdqId, category, date]) // combo de recherche pdq, categorie et data

}

// Pour le suivi des incréments d'import
model ImportCursor {
  source        String   @id
  lastDate      DateTime?
  lastSourceId  Int?
  lastRunAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Pour le suivi des incréments d'import déjà importer en reculant
model ImportBootstrapState {
  id          String   @id @default("spvm_incidents_bootstrap")
  source      String   @unique
  nextOffset  Int      @default(0)
  updatedAt   DateTime @updatedAt
}


model User {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  clerkId   String    @unique
  email     String?

  role      Role      @default(USER)

  profile   UserProfile?
  locations SavedLocation[]
}

model UserProfile {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  homeLat       Float?
  homeLng       Float?
  homeRadiusM   Int?
}

model SavedLocation {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  label       String
  lat         Float
  lng         Float
  radiusM     Int
}

