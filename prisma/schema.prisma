generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}


enum TimePeriod {
  jour
  nuit
  soir
}

enum Role {
  USER
  ADMIN
  MODERATOR
}


model Pdq {
  id              Int        @id
  name            String     @default("")
  address         String     @default("")
  cityCode        String     @default("")
  latitude        Float      @default(0)
  longitude       Float      @default(0)

  incidents Incident[]         
}

model Incident {
  id              Int       @id @default(autoincrement())
  source          String
  sourceId        Int

  @@unique([source, sourceId], name: "source_sourceId")
  category        String
  date            DateTime
  timePeriod      TimePeriod

  // Geometrie 
  x               Float?
  y               Float?
  longitude       Float?
  latitude        Float?

  // PDQ relation
  pdqId           Int
  pdq             Pdq       @relation(fields: [pdqId], references: [id])

  // Indexes
  @@index([pdqId, date])
  @@index([date])
  @@index([category])
  @@index([pdqId, category, date])

}

// Pour le suivi des incréments d'import
model ImportCursor {
  source        String   @id
  lastDate      DateTime?
  lastSourceId  Int?
  lastRunAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Pour le suivi des incréments d'import déjà importer en reculant
model ImportBootstrapState {
  id          String   @id @default("spvm_incidents_bootstrap")
  source      String   @unique
  nextOffset  Int      @default(0)
  updatedAt   DateTime @updatedAt
}


model User {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  clerkId   String    @unique
  email     String?

  role      Role      @default(USER)

  profile   UserProfile?
  locations SavedLocation[]
}


model UserProfile {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  homeLat       Float?
  homeLng       Float?
  homeRadiusM   Int?
}

model SavedLocation {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  label       String
  lat         Float
  lng         Float
  radiusM     Int
}

